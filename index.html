<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amount Distribution Tool</title>
    <!-- Font Awesome Icons (Add here) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f4f4f4;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
        }

        label {
            font-weight: bold;
            display: block;
            margin: 10px 0 5px;
        }

        input,
        button {
            width: 100%;
            padding: 10px;
            margin: 5px 0 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .inline-inputs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .inline-input {
            flex: 1;
        }

        .section {
            margin-top: 20px;
            padding: 15px;
            background: #fafafa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }

        table,
        th,
        td {
            border: 1px solid #ddd;
        }

        th,
        td {
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: #f4f4f4;
            font-weight: bold;
        }

        .matrix-group-header {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            text-align: center;
        }

        .matrix-member-row {
            background-color: #f9f9f9;
        }

        .matrix-member-row:nth-child(odd) {
            background-color: #e9ecef;
        }

        .matrix-total-row {
            background-color: #d1ecf1;
            font-weight: bold;
            border-top: 2px solid #007bff;
        }

        .matrix-table-wrapper {
            overflow-x: auto;
        }

        .message {
            color: green;
            font-weight: bold;
            margin-top: 5px;
        }

        .success-message {
            color: green;
            font-weight: bold;
            margin: 10px 0;
        }

        .export-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .export-icons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }

        .export-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: #007bff;
            font-size: 1.5rem;
        }

        .export-icon:hover {
            color: #0056b3;
        }

        .export-icon span {
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .export-icon i {
            font-size: 2rem;
        }


        /* Chart container style */
        .chart-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .chart-section {
            margin: 20px auto;
            width: 90%;
            max-width: 800px;
            /* Limit max width to 800px */
            text-align: center;
        }

        canvas {
            width: 100% !important;
            /* Make canvas responsive */
            height: 400px !important;
            /* Set a height for better display */
            max-height: 400px;
        }

        @media (max-width: 768px) {

            table,
            th,
            td {
                font-size: 12px;
                padding: 8px;
            }

            input,
            button {
                padding: 8px;
                font-size: 14px;
            }

            canvas {
                height: 300px !important;
                /* Reduce height for smaller screens */
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Amount Distribution Tool</h1>

        <!-- Amount Input Section -->
        <div class="section" id="amountSection">
            <h2>Total Amount (â‚¹)</h2>
            <div class="inline-inputs">
                <input type="number" id="totalAmount" placeholder="Enter the total amount">
                <button id="addAmount">Add Amount</button>
            </div>
            <p id="amountPreview"></p>
        </div>

        <!-- Contributor Group Section -->
        <div class="section" id="contributorSection">
            <h2>Contributor Group</h2>
            <!-- Success Message -->
            <p id="contributorSuccessMessage" class="success-message" style="display: none;">
                Contributor group added successfully!
            </p>
            <div class="inline-inputs">
                <!-- Group Input Fields -->
                <input type="text" id="contributorGroupName" placeholder="Contributor Group Name" required>
                <input type="number" id="contributorPercentage" placeholder="Percentage (%)" required>
                <input type="text" id="contributorMembers" placeholder="Members (comma-separated)" required>

                <!-- Hidden Input Field to store edit index -->
                <input type="hidden" id="editIndex" value="">

                <!-- Action Buttons -->
                <button id="addContributorGroup">Add Contributor Group</button>
                <button id="updateContributorGroup" style="display: none;">Update Contributor Group</button>
            </div>
            <p id="contributorMessage" class="success-message"></p>
            <table id="contributorPreviewTable">
                <thead>
                    <tr>
                        <th>Group Name</th>
                        <th>Percentage (%)</th>
                        <th>Members</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="contributorPreviewBody"></tbody>
            </table>
        </div>

        <!-- Receiver Group Section -->
        <div class="section" id="receiverSection">
            <h2>Receiver Group</h2>
            <!-- Success Message -->
            <p id="receiverSuccessMessage" class="success-message" style="display: none;">
                Receiver group added successfully!
            </p>
            <div class="inline-inputs">
                <!-- Group Input Fields -->
                <input type="text" id="receiverGroupName" placeholder="Receiver Group Name" required>
                <input type="number" id="receiverPercentage" placeholder="Percentage (%)" required>
                <input type="text" id="receiverMembers" placeholder="Members (comma-separated)" required>

                <!-- Hidden Input Field to store edit index -->
                <input type="hidden" id="editIndex" value="">

                <!-- Action Buttons -->
                <button id="addReceiverGroup">Add Receiver Group</button>
                <button id="updateReceiverGroup" style="display: none;">Update Receiver Group</button>
            </div>
            <p id="receiverMessage" class="success-message"></p>
            <table id="receiverPreviewTable">
                <thead>
                    <tr>
                        <th>Group Name</th>
                        <th>Percentage (%)</th>
                        <th>Members</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Call-to-Action Buttons -->
        <div class="cta-buttons">
            <button id="calculate">Calculate</button>
            <button id="resetPage">Reset</button>
        </div>

        <!-- Export Data Section -->
        <div class="export-section">
            <h3>Export Data</h3>
            <div class="export-icons">
                <div class="export-icon" id="exportPNG">
                    <i class="fas fa-file-image"></i>
                    <span>PNG</span>
                </div>
                <div class="export-icon" id="exportPDF">
                    <i class="fas fa-file-pdf"></i>
                    <span>PDF</span>
                </div>
                <div class="export-icon" id="exportCSV">
                    <i class="fas fa-file-csv"></i>
                    <span>CSV</span>
                </div>
                <div class="export-icon" id="exportExcel">
                    <i class="fas fa-file-excel"></i>
                    <span>Excel</span>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="section" id="resultSection">
            <h2>Results: Receiver's Perspective</h2>
            <div class="matrix-table-wrapper">
                <table id="matrixTableReceiver">
                    <thead>
                        <tr>
                            <th>Receiver Group / Member</th>
                            <th>Contributor Group / Member</th>
                            <th>Amount (â‚¹)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <h2>Results: Contributor's Perspective</h2>
            <div class="matrix-table-wrapper">
                <table id="matrixTableContributor">
                    <thead>
                        <tr>
                            <th>Contributor Group / Member</th>
                            <th>Receiver Group / Member</th>
                            <th>Amount (â‚¹)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>


        <div class="chart-container">
            <h3>Charts</h3>
            <div class="cta-buttons">
                <!-- New Show Graphs Button -->
                <button id="showGraphs">Show Graphs</button>
            </div>
            <!-- Chart Section -->
            <!-- Chart Section for Receiver's Perspective -->
            <div class="chart-section" style="display: none;" id="chartSectionReceiver">
                <h2>Receiver's Perspective Chart</h2>
                <canvas id="receiverChart"></canvas>
            </div>

            <!-- Chart Section for Contributor's Perspective -->
            <div class="chart-section" style="display: none;" id="chartSectionContributor">
                <h2>Contributor's Perspective Chart</h2>
                <canvas id="contributorChart"></canvas>
            </div>
            <label for="chartType">Select Chart Type:</label>
            <select id="chartType">
                <option value="bar">Stacked Bar</option>
                <option value="grouped-bar">Grouped Bar</option>
                <option value="pie">Pie Chart</option>
            </select>
        </div>
    </div>
    <script>
        let contributors = [];
        let receivers = [];

        // Add Amount CTA
        document.getElementById("addAmount").addEventListener("click", function () {
            const totalAmount = parseFloat(document.getElementById("totalAmount").value);
            if (isNaN(totalAmount) || totalAmount <= 0) {
                alert("Please enter a valid amount!");
                return;
            }
            document.getElementById("amountPreview").textContent = `Amount added: â‚¹${totalAmount}`;
        });

        // Restrict input in the members field to valid characters only
        document.getElementById("contributorMembers").addEventListener("input", function () {
            this.value = this.value.replace(/[^A-Za-z0-9,]/g, '');
        });
        // Add Contributor Group CTA
        document.getElementById("addContributorGroup").addEventListener("click", function () {
            const name = document.getElementById("contributorGroupName").value;
            const percentage = parseFloat(document.getElementById("contributorPercentage").value);
            const members = document.getElementById("contributorMembers").value.split(",");

            if (!name || isNaN(percentage) || percentage <= 0 || !members.length) {
                alert("Please fill out all contributor fields!");
                return;
            }

            // Check if the input matches the valid pattern
            if (!/^[A-Za-z0-9,]+$/.test(members)) {
                alert("Invalid input! Only letters, numbers, and commas are allowed.");
                return;
            }

            // Proceed with form submission
            console.log("Contributor group added successfully.");

            contributors.push({ name, percentage, members });
            // Clear input fields
            clearContributorFields();
            // Refresh the preview table
            displayContributorGroups();
            // Show success message
            const successMessage = document.getElementById("contributorSuccessMessage");
            successMessage.style.display = "block";

            // Hide the message after 3 seconds
            setTimeout(function () {
                successMessage.style.display = "none";
            }, 3000);
        });


        // Restrict input in the members field to valid characters only
        document.getElementById("receiverMembers").addEventListener("input", function () {
            this.value = this.value.replace(/[^A-Za-z0-9,]/g, '');
        });
        // Add Receiver Group CTA
        document.getElementById("addReceiverGroup").addEventListener("click", function () {
            const name = document.getElementById("receiverGroupName").value;
            const percentage = parseFloat(document.getElementById("receiverPercentage").value);
            const members = document.getElementById("receiverMembers").value.split(",");

            if (!name || isNaN(percentage) || percentage <= 0 || !members.length) {
                alert("Please fill out all receiver fields!");
                return;
            }

            // Check if the input matches the valid pattern
            if (!/^[A-Za-z0-9,]+$/.test(members)) {
                alert("Invalid input! Only letters, numbers, and commas are allowed.");
                return;
            }

            receivers.push({ name, percentage, members });

            // Clear input fields
            clearReceiverFields();

            // Refresh the preview table
            displayReceiverGroups();

            // Show success message
            const successMessage = document.getElementById("receiverSuccessMessage");
            successMessage.style.display = "block";

            // Hide the message after 3 seconds
            setTimeout(function () {
                successMessage.style.display = "none";
            }, 3000);
        });

        // Send data to backend on Calculate button click
        document.getElementById("calculate").addEventListener("click", function () {
            const totalAmount = parseFloat(document.getElementById("totalAmount").value);
            if (isNaN(totalAmount) || totalAmount <= 0) {
                alert("Please enter a valid total amount!");
                return;
            }

            fetch("/calculate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    total_amount: totalAmount,
                    contributors: contributors,
                    receivers: receivers
                })
            })
                .then(response => response.json())
                .then(data => {
                    displayMatrixReceiver(data);
                    displayMatrixContributor(data);
                });
        });

        // Display Matrix Receiver View Results
        function displayMatrixReceiver(data) {
            const tbody = document.getElementById("matrixTableReceiver").querySelector("tbody");
            tbody.innerHTML = "";

            data.matrix.forEach(group => {
                const groupHeaderRow = document.createElement("tr");
                groupHeaderRow.classList.add("matrix-group-header");
                groupHeaderRow.innerHTML = `<td colspan="3">Receiver Group: ${group.group_name}</td>`;
                tbody.appendChild(groupHeaderRow);

                group.members.forEach(member => {
                    const memberRow = document.createElement("tr");
                    memberRow.classList.add("matrix-member-row");
                    memberRow.innerHTML = `<td>${member.receiver}</td><td>Total</td><td>â‚¹${member.subtotal.toFixed(2)}</td>`;
                    tbody.appendChild(memberRow);

                    member.details.forEach(detail => {
                        const detailRow = document.createElement("tr");
                        detailRow.innerHTML = `<td></td><td>${detail.contributor}</td><td>â‚¹${detail.amount.toFixed(2)}</td>`;
                        tbody.appendChild(detailRow);
                    });
                });

                const totalRow = document.createElement("tr");
                totalRow.classList.add("matrix-total-row");
                totalRow.innerHTML = `<td colspan="2">Group Total</td><td>â‚¹${group.group_total.toFixed(2)}</td>`;
                tbody.appendChild(totalRow);
            });

            const overallRow = document.createElement("tr");
            overallRow.classList.add("matrix-total-row");
            overallRow.innerHTML = `<td colspan="2">Overall Total</td><td>â‚¹${data.overall_total.toFixed(2)}</td>`;
            tbody.appendChild(overallRow);
        }

        // Display Matrix Contributor View Results
        function displayMatrixContributor(data) {
            const tbody = document.getElementById("matrixTableContributor").querySelector("tbody");
            tbody.innerHTML = "";

            const contributorData = {};
            data.matrix.forEach(group => {
                group.members.forEach(member => {
                    member.details.forEach(detail => {
                        if (!contributorData[detail.contributor]) {
                            contributorData[detail.contributor] = [];
                        }

                        contributorData[detail.contributor].push({
                            receiverGroup: group.group_name,
                            receiverMember: member.receiver,
                            amount: detail.amount
                        });
                    });
                });
            });

            for (const [contributor, contributions] of Object.entries(contributorData)) {
                const contributorHeaderRow = document.createElement("tr");
                contributorHeaderRow.classList.add("matrix-group-header");
                contributorHeaderRow.innerHTML = `<td colspan="3">Contributor: ${contributor}</td>`;
                tbody.appendChild(contributorHeaderRow);

                let contributorTotal = 0;
                contributions.forEach(entry => {
                    const contributionRow = document.createElement("tr");
                    contributionRow.classList.add("matrix-member-row");
                    contributionRow.innerHTML = `<td></td><td>${entry.receiverMember}</td><td>â‚¹${entry.amount.toFixed(2)}</td>`;
                    tbody.appendChild(contributionRow);
                    contributorTotal += entry.amount;
                });

                const totalRow = document.createElement("tr");
                totalRow.classList.add("matrix-total-row");
                totalRow.innerHTML = `<td colspan="2">Contributor Total</td><td>â‚¹${contributorTotal.toFixed(2)}</td>`;
                tbody.appendChild(totalRow);
            }
        }


        // Get Matix Data        
        function getMatrixData() {
            const matrix = [];

            // Read data from Receiver's table
            const receiverTable = document.getElementById("matrixTableReceiver").querySelector("tbody").rows;
            let currentGroup = null;

            Array.from(receiverTable).forEach(row => {
                const cells = row.cells;

                // Check if the row has cells to avoid undefined errors
                if (!cells || cells.length === 0) return;

                // Group Header Row (with colspan)
                if (row.classList.contains("matrix-group-header")) {
                    currentGroup = { group_name: cells[0].textContent.replace("Receiver Group: ", ""), members: [] };
                    matrix.push(currentGroup);
                }

                // Receiver Member Row
                else if (cells.length >= 3 && cells[1].textContent === "Total") {
                    currentGroup.members.push({
                        receiver: cells[0].textContent,
                        subtotal: parseFloat(cells[2].textContent.replace("â‚¹", "").replace(",", "").trim()),
                        details: []
                    });
                }

                // Contributor Details Row
                else if (cells.length >= 3 && cells[1].textContent) {
                    const lastMember = currentGroup.members[currentGroup.members.length - 1];
                    if (lastMember) {
                        lastMember.details.push({
                            contributor: cells[1].textContent,
                            amount: parseFloat(cells[2].textContent.replace("â‚¹", "").replace(",", "").trim())
                        });
                    }
                }
            });

            return { matrix };
        }


        // Clear field Post Add Contrinbutor CTA
        function clearContributorFields() {
            document.getElementById("contributorGroupName").value = "";
            document.getElementById("contributorPercentage").value = "";
            document.getElementById("contributorMembers").value = "";
        }

        // Clear field Post Add Receiever CTA 
        function clearReceiverFields() {
            document.getElementById("receiverGroupName").value = "";
            document.getElementById("receiverPercentage").value = "";
            document.getElementById("receiverMembers").value = "";
        }

        // Display Contributor group in preview table   
        function displayContributorGroups() {
            const tbody = document.getElementById("contributorPreviewTable").querySelector("tbody");
            tbody.innerHTML = "";

            contributors.forEach((group, index) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td>${group.name}</td>
            <td>${group.percentage}</td>
            <td>${group.members.join(", ")}</td>
            <td>
                <a href="#" class="contributor-edit-link" data-index="${index}">Edit</a> |
                <a href="#" class="contributor-delete-link" data-index="${index}">Delete</a>
            </td>
        `;
                tbody.appendChild(tr);
            });
        }

        // Added an event listener for Edit links. When clicked, it populates the input fields for editing: (Contributor Group)
        document.addEventListener("click", function (event) {
            if (event.target.classList.contains("contributor-edit-link")) {
                event.preventDefault();

                const index = event.target.getAttribute("data-index");
                const group = contributors[index];

                // Populate input fields
                document.getElementById("contributorGroupName").value = group.name;
                document.getElementById("contributorPercentage").value = group.percentage;
                document.getElementById("contributorMembers").value = group.members.join(", ");

                // Set the index for updating
                document.getElementById("editIndex").value = index;

                // Show update button and hide add button
                document.getElementById("addContributorGroup").style.display = "none";
                document.getElementById("updateContributorGroup").style.display = "block";
            }
        });

        // Added a handler to save the updated group details (Contributor Group)
        document.getElementById("updateContributorGroup").addEventListener("click", function () {
            const index = document.getElementById("editIndex").value;

            // Update the group data
            contributors[index] = {
                name: document.getElementById("contributorGroupName").value,
                percentage: parseFloat(document.getElementById("contributorPercentage").value),
                members: document.getElementById("contributorMembers").value.split(",").map(m => m.trim())
            };

            // Refresh the preview and reset the form
            displayContributorGroups();
            clearContributorFields();

            // Switch buttons
            document.getElementById("addContributorGroup").style.display = "block";
            document.getElementById("updateContributorGroup").style.display = "none";
        });

        // Added a handler for deleting a group: (Contributor Group)
        document.addEventListener("click", function (event) {
            if (event.target.classList.contains("contributor-delete-link")) {
                event.preventDefault();

                const index = event.target.getAttribute("data-index");

                // Ask for confirmation before deleting
                if (confirm("Are you sure you want to delete this Contributor group?")) {
                    // Remove the group and refresh the preview
                    contributors.splice(index, 1);
                    displayContributorGroups();
                }
            }
        });

        // Display Receiver group in preview table     
        function displayReceiverGroups() {
            const tbody = document.getElementById("receiverPreviewTable").querySelector("tbody");
            tbody.innerHTML = "";

            receivers.forEach((group, index) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${group.name}</td>
                    <td>${group.percentage}</td>
                    <td>${group.members.join(", ")}</td>
            <td>
                <a href="#" class="receiver-edit-link" data-index="${index}">Edit</a> |
                <a href="#" class="receiver-delete-link" data-index="${index}">Delete</a>
            </td>
            `;
                tbody.appendChild(tr);
            });
        }

        // Added an event listener for Edit links. When clicked, it populates the input fields for editing: (Receiver Group)
        document.addEventListener("click", function (event) {
            if (event.target.classList.contains("receiver-edit-link")) {
                event.preventDefault();

                const index = event.target.getAttribute("data-index");
                const group = receivers[index];

                // Populate input fields
                document.getElementById("receiverGroupName").value = group.name;
                document.getElementById("receiverPercentage").value = group.percentage;
                document.getElementById("receiverMembers").value = group.members.join(", ");

                // Set the index for updating
                document.getElementById("editIndex").value = index;

                // Show update button and hide add button
                document.getElementById("addReceiverGroup").style.display = "none";
                document.getElementById("updateReceiverGroup").style.display = "block";
            }
        });

        // Added a handler to save the updated group details (Receiver Group)
        document.getElementById("updateReceiverGroup").addEventListener("click", function () {
            const index = document.getElementById("editIndex").value;

            // Update the group data
            receivers[index] = {
                name: document.getElementById("receiverGroupName").value,
                percentage: parseFloat(document.getElementById("receiverPercentage").value),
                members: document.getElementById("receiverMembers").value.split(",").map(m => m.trim())
            };

            // Refresh the preview and reset the form
            displayReceiverGroups();
            clearReceiverFields();

            // Switch buttons
            document.getElementById("addReceiverGroup").style.display = "block";
            document.getElementById("updateReceiverGroup").style.display = "none";
        });

        // Added a handler for deleting a group: (Receiver Group)
        document.addEventListener("click", function (event) {
            if (event.target.classList.contains("receiver-delete-link")) {
                event.preventDefault();

                const index = event.target.getAttribute("data-index");

                // Ask for confirmation before deleting
                if (confirm("Are you sure you want to delete this Receiver group?")) {
                    // Remove the group and refresh the preview
                    receivers.splice(index, 1);
                    displayReceiverGroups();
                }
            }
        });

        // Function to clean and extract text content
        function trimText(text) {
            return text ? text.trim() : "";
        }

        let contributorChartInstance = null;
        let receiverChartInstance = null;

        // Function to render the charts
        function renderCharts(chartType = 'bar') {
            // --- Destroy existing charts if they exist ---
            if (contributorChartInstance) {
                contributorChartInstance.destroy();
            }
            if (receiverChartInstance) {
                receiverChartInstance.destroy();
            }

            // --- Contributors Perspective Chart ---
            const receiverRows = document.getElementById("matrixTableReceiver").querySelector("tbody").rows;

            const receivers = [];
            const contributors = new Set();
            const contributorData = {};

            Array.from(receiverRows).forEach(row => {
                const cells = row.cells;
                if (cells.length === 3) {
                    const receiver = trimText(cells[0].textContent);
                    const contributor = trimText(cells[1].textContent);
                    const amount = parseFloat(trimText(cells[2].textContent).replace(/â‚¹/, ''));

                    if (!receivers.includes(receiver)) receivers.push(receiver);
                    contributors.add(contributor);

                    if (!contributorData[receiver]) contributorData[receiver] = {};
                    contributorData[receiver][contributor] = (contributorData[receiver][contributor] || 0) + amount;
                }
            });

            const contributorsArray = Array.from(contributors);

            // Datasets for Contributors Perspective
            const contributorDatasets = contributorsArray.map((contributor, index) => ({
                label: contributor,
                data: receivers.map(receiver => contributorData[receiver][contributor] || 0),
                backgroundColor: `rgba(${(index * 60) % 255}, ${(index * 90) % 255}, 180, 0.5)`,
                borderColor: `rgba(${(index * 60) % 255}, ${(index * 90) % 255}, 180, 1)`,
                borderWidth: 1
            }));

            // --- Render Contributors Perspective Chart ---
            const contributorCtx = document.getElementById('contributorChart').getContext('2d');
            contributorChartInstance = new Chart(contributorCtx, {
                type: chartType === 'grouped-bar' ? 'bar' : chartType,
                data: {
                    labels: receivers,  // Your parsed receiver data
                    datasets: contributorDatasets  // Your parsed contributor data
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    return `${tooltipItem.dataset.label} to ${tooltipItem.label}: â‚¹${tooltipItem.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: chartType === 'pie' ? {} : {
                        x: {
                            stacked: chartType === 'bar',
                            title: { display: true, text: 'Receivers' }
                        },
                        y: {
                            stacked: chartType === 'bar',
                            beginAtZero: true,
                            title: { display: true, text: 'Amount (â‚¹)' }
                        }
                    }
                }
            });

            // --- Receivers Perspective Chart ---
            const receiverDatasets = receivers.map((receiver, index) => ({
                label: receiver,
                data: contributorsArray.map(contributor => contributorData[receiver][contributor] || 0),
                backgroundColor: `rgba(${(index * 70) % 255}, ${(index * 110) % 255}, 150, 0.5)`,
                borderColor: `rgba(${(index * 70) % 255}, ${(index * 110) % 255}, 150, 1)`,
                borderWidth: 1
            }));

            const receiverCtx = document.getElementById('receiverChart').getContext('2d');
            receiverChartInstance = new Chart(receiverCtx, {
                type: chartType === 'grouped-bar' ? 'bar' : chartType,
                data: {
                    labels: contributorsArray,  // Your parsed contributor data
                    datasets: receiverDatasets  // Your parsed receiver data
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    return `${tooltipItem.dataset.label} from ${tooltipItem.label}: â‚¹${tooltipItem.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: chartType === 'pie' ? {} : {
                        x: {
                            stacked: chartType === 'bar',
                            title: { display: true, text: 'Contributors' }
                        },
                        y: {
                            stacked: chartType === 'bar',
                            beginAtZero: true,
                            title: { display: true, text: 'Amount (â‚¹)' }
                        }
                    }
                }
            });
        }


        // Event listener for the "Show Graphs" button
        document.getElementById("showGraphs").addEventListener("click", function () {
            // Show the chart sections
            document.getElementById("chartSectionReceiver").style.display = "block";
            document.getElementById("chartSectionContributor").style.display = "block";

            // Render the charts with default chart type
            renderCharts('bar');
        });

        // Event listener to handle chart type selection
        document.getElementById("chartType").addEventListener("change", function () {
            const chartType = this.value;

            // Re-render charts with the selected type
            renderCharts(chartType);
        });

        // PNG Export
        document.getElementById("exportPNG").addEventListener("click", function () {
            // Export Receiver's Perspective Table as PNG
            const receiverTable = document.getElementById("matrixTableReceiver");
            html2canvas(receiverTable, { scale: 2 }).then(canvas => {
                const link = document.createElement("a");
                link.href = canvas.toDataURL("image/png");
                link.download = "receiver_perspective.png";
                link.click();
            });

            // Export Contributor's Perspective Table as PNG
            const contributorTable = document.getElementById("matrixTableContributor");
            html2canvas(contributorTable, { scale: 2 }).then(canvas => {
                const link = document.createElement("a");
                link.href = canvas.toDataURL("image/png");
                link.download = "contributor_perspective.png";
                link.click();
            });
        });

        // Export PDF Button Event Listener
        document.getElementById("exportPDF").addEventListener("click", function () {
            fetch("/export_pdf", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(getMatrixData())
            })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "amount_distribution.pdf";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                });
        });

        // Export CSV Button Event Listener
        document.getElementById("exportCSV").addEventListener("click", function () {
            fetch("/export_csv", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(getMatrixData())
            })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "amount_distribution.csv";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                });
        });

        // Export Excel Button Event Listener
        document.getElementById("exportExcel").addEventListener("click", function () {
            // Gather data from Receiver's table
            const receiverData = [["Receiver Group", "Receiver Member", "Contributor", "Amount (â‚¹)"]];
            const receiverRows = document.getElementById("matrixTableReceiver").querySelector("tbody").rows;

            Array.from(receiverRows).forEach(row => {
                const cells = row.cells;
                if (cells.length === 3) {
                    receiverData.push([cells[0].textContent, cells[1].textContent, cells[2].textContent]);
                }
            });

            // Gather data from Contributor's table
            const contributorData = [["Contributor", "Receiver Group / Member", "Amount (â‚¹)"]];
            const contributorRows = document.getElementById("matrixTableContributor").querySelector("tbody").rows;

            Array.from(contributorRows).forEach(row => {
                const cells = row.cells;
                if (cells.length === 3) {
                    contributorData.push([cells[0].textContent, cells[1].textContent, cells[2].textContent]);
                }
            });

            // Create Excel workbook and sheets
            const wb = XLSX.utils.book_new();

            // Add Receiver's Perspective sheet
            const wsReceiver = XLSX.utils.aoa_to_sheet(receiverData);
            XLSX.utils.book_append_sheet(wb, wsReceiver, "Receiver's Perspective");

            // Add Contributor's Perspective sheet
            const wsContributor = XLSX.utils.aoa_to_sheet(contributorData);
            XLSX.utils.book_append_sheet(wb, wsContributor, "Contributor's Perspective");

            // Export the workbook
            XLSX.writeFile(wb, "amount_distribution.xlsx");
        });

        // Reset Button Event Listener
        document.addEventListener("DOMContentLoaded", function () {
            // Attach the reset button event listener
            const resetButton = document.getElementById("resetPage");

            if (resetButton) {
                resetButton.addEventListener("click", function () {
                    console.log("Reset button clicked!");

                    // Scroll to the top of the page
                    window.scrollTo(0, 0);

                    // Reload the page to reset all fields, tables, and data
                    location.reload();
                });
            } else {
                console.error("Reset button not found!");
            }
        });


    </script>
</body>

</html>