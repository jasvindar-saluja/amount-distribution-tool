<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amount Distribution Tool</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico?v=1.0">
    <link rel="manifest" href="/manifest.json"> <meta name="theme-color" content="#007bff">
    <!-- Font Awesome Icons (Add here) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => console.log('Service Worker registered:', registration))
                .catch(error => console.error('Service Worker registration failed:', error));
        }
    </script>
    <style>
        /* Body and Wrapper Styling */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            color: #212529;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .page-wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            /* Full viewport height */
        }



        .container {
            background-color: #ffffff;
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px auto;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            border-radius: 8px;
        }

        /* Header Styling */
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            background-color: #007bff;
            color: white;
            border-bottom: 2px solid #0056b3;
            width: 100%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Main Container (Takes remaining space) */
        .main-container {
            flex: 1;
            padding: 20px;
            max-width: 900px;
            margin: 20px auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header h1 {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }

        .header .logo {
            height: 50px;
            width: 50px;
        }

        label {
            font-weight: bold;
            display: block;
            margin: 10px 0 5px;
        }

        /* Input Fields */
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            border-color: #007bff;
            outline: none;
        }

        /* Buttons */
        button {
            background-color: #007bff;
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        .inline-inputs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .inline-input {
            flex: 1;
        }

        .section {
            margin-top: 20px;
            padding: 15px;
            background: #fafafa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        /* Default Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        table th,
        table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        th,
        td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }

        th {
            background-color: #f4f4f4;
            font-weight: bold;
        }

        /* Matrix Group Header */
        .matrix-group-header {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            text-align: center;
        }

        /* Matrix Member Row */
        .matrix-member-row {
            background-color: #f9f9f9;
        }

        /* Alternate Row Color */
        .matrix-member-row:nth-child(odd) {
            background-color: #e9ecef;
        }

        /* Matrix Total Row */
        .matrix-total-row {
            background-color: #d1ecf1;
            font-weight: bold;
            border-top: 2px solid #007bff;
        }

        .matrix-table-wrapper {
            overflow-x: auto;
        }

        .message {
            color: green;
            font-weight: bold;
            margin-top: 5px;
        }

        .success-message {
            color: green;
            font-weight: bold;
            margin: 10px 0;
        }

        .export-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .export-icons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }


        .export-icon {
            display: inline-block;
            margin: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }

        .export-icon:hover {
            background-color: #e0e0e0;
        }

        .export-icon i {
            font-size: 24px;
        }

        .export-icon span {
            display: block;
            margin-top: 5px;
        }

        /* Chart Controls Styling */
        .chart-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        /* Styled Dropdown */
        .styled-dropdown {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #ffffff;
            color: #212529;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .styled-dropdown:focus {
            border-color: #007bff;
            outline: none;
        }



        /* CTA Section Styling */
        .cta-section {
            margin-top: 20px;
            padding: 15px;
            text-align: center;
            background-color: #f4f4f4;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        /* Styled Buttons */
        .styled-btn {
            display: inline-block;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px 5px;
            background-color: #6c757d;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .styled-btn:hover {
            background-color: #5a6268;
            transform: translateY(-3px);
        }

        /* Amount Button */
        .amount-btn {
            background-color: #28a745;
            /* Green */
        }

        .amount-btn:hover {
            background-color: #218838;
            transform: translateY(-3px);
        }

        /* Contributor Button */
        .contributor-btn {
            background-color: #17a2b8;
            /* Teal */
        }

        .contributor-btn:hover {
            background-color: #138496;
            transform: translateY(-3px);
        }

        /* Receiver Button */
        .receiver-btn {
            background-color: #ffc107;
            /* Yellow */
            color: #212529;
        }

        .receiver-btn:hover {
            background-color: #e0a800;
            transform: translateY(-3px);
        }

        /* Calculate Button */
        .calculate-btn {
            background-color: #007bff;
        }

        .calculate-btn:hover {
            background-color: #0056b3;
            transform: translateY(-3px);
        }

        /* Reset Button */
        .reset-btn {
            background-color: #dc3545;
        }

        .reset-btn:hover {
            background-color: #b21f2d;
            transform: translateY(-3px);
        }

        /* Graphs Button */
        .graph-btn {
            background-color: #6c757d;
            /* Grey */
        }

        .graph-btn:hover {
            background-color: #5a6268;
            transform: translateY(-3px);
        }

        /* Chart container style */
        .chart-container {
            margin-top: 20px;
            padding: 15px;
            margin-bottom: 30px;
            /* Add enough spacing to prevent overlap with footer */
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .chart-section {
            margin: 20px auto;
            width: 90%;
            max-width: 800px;
            /* Limit max width to 800px */
            text-align: center;
        }

        canvas {
            width: 100% !important;
            /* Make canvas responsive */
            height: 400px !important;
            /* Set a height for better display */
            max-height: 400px;
        }


        /* Footer Styling */
        .footer {
            text-align: center;
            padding: 15px;
            background-color: #007bff;
            color: white;
            border-top: 2px solid #0056b3;

            bottom: 0;
            left: 0;
            width: 100%;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1000;
        }

        #searchInput {
            width: 50%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            outline: none;
        }

        #searchInput:focus {
            border-color: #007bff;
        }


        /* Theme Toggle Button */
        .theme-icon {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #f1f1f1;
            border-radius: 50%;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 999;
            transition: background-color 0.3s ease;
        }

        .theme-icon i {
            font-size: 24px;
            color: #555;
        }

        /* Hover effects */
        .theme-icon:hover {
            background-color: #ddd;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #121212;
            color: #ffffff;
        }

        .dark-mode .container {
            background-color: #1e1e1e;
            border: 1px solid #444;
            box-shadow: 0 2px 5px rgba(255, 255, 255, 0.1);
        }

        .dark-mode .main-container {
            background-color: #1e1e1e;
            border: 1px solid #444;
            box-shadow: 0 2px 5px rgba(255, 255, 255, 0.1);
        }

        .dark-mode h1,
        .dark-mode h2,
        .dark-mode h3,
        .dark-mode label {
            color: #ffffff;
        }

        .dark-mode input[type="text"],
        .dark-mode input[type="number"] {
            background-color: #2c2c2c;
            color: #ffffff;
            border: 1px solid #555;
        }

        body.dark-mode input {
            background-color: #2c2c2c;
            color: #ffffff;
            border: 1px solid #555;
        }

        .dark-mode button {
            background-color: #333;
            color: #ffffff;
        }

        /* Buttons in dark mode */
        body.dark-mode button {
            background-color: #333;
            color: #ffffff;
        }

        .dark-mode table {
            background-color: #1e1e1e;
            color: #ffffff;
        }

        .dark-mode th {
            background-color: #444;
            color: #ffffff;
        }

        .dark-mode .theme-icon {
            background-color: #333;
        }

        .dark-mode .theme-icon i {
            color: #ffffff;
        }

        /* ----- Dark Mode Table Styling ----- */
        body.dark-mode table {
            background-color: #1e1e1e;
            color: white;
        }

        body.dark-mode th {
            background-color: #444;
            color: white;
        }

        body.dark-mode td {
            border: 1px solid #555;
        }

        /* Dark Mode Group Header */
        body.dark-mode .matrix-group-header {
            background-color: #0056b3;
            /* Darker blue */
            color: #ffffff;
        }

        /* Dark Mode Member Row */
        body.dark-mode .matrix-member-row {
            background-color: #2c2c2c;
        }

        body.dark-mode .matrix-member-row:nth-child(odd) {
            background-color: #333;
        }

        /* Dark Mode Total Row */
        body.dark-mode .matrix-total-row {
            background-color: #444;
            color: white;
            border-top: 2px solid #007bff;
        }

        body.dark-mode .matrix-member-row:nth-child(odd) {
            background-color: #333;
        }

        body.dark-mode .matrix-total-row {
            background-color: #555;
        }


        body.dark-mode .cta-section {
            background-color: #1e1e1e;
            border: 1px solid #555;
        }

        body.dark-mode .export-icon:hover {
            background-color: #444;
        }

        .search-container {
            margin: 20px;
            text-align: center;
        }

        body.dark-mode .chart-container {
            background-color: #1e1e1e;
            border: 1px solid #444;
        }

        body.dark-mode .header,
        body.dark-mode .footer {
            background-color: #1e1e1e;
            border-color: #444;
        }

        body.dark-mode .logo {
            filter: brightness(80%);
        }

        body.dark-mode #searchInput {
            background-color: #2c2c2c;
            color: white;
            border: 1px solid #555;
        }

        body.dark-mode th {
            background-color: #444;
            color: white;
        }

        body.dark-mode td {
            border: 1px solid #555;
        }

        /* Chart container in dark mode */
        body.dark-mode .chart-container {
            background-color: #1e1e1e;
            border: 1px solid #444;
        }

        /* Export data section */
        body.dark-mode .export-section {
            background-color: #1e1e1e;
            border: 1px solid #444;
        }

        /* Search input in dark mode */
        body.dark-mode #searchInput {
            background-color: #2c2c2c;
            color: white;
            border: 1px solid #555;
        }

        /* Dark mode section styles */
        body.dark-mode .section {
            background: #1e1e1e;
            border: 1px solid #444;
        }

        /* Dark Mode Button Styling */
        body.dark-mode .styled-btn {
            color: #ffffff;
        }

        body.dark-mode .calculate-btn {
            background-color: #0056b3;
        }

        body.dark-mode .reset-btn {
            background-color: #b21f2d;
        }

        /* Dark Mode Buttons */
        body.dark-mode .styled-btn {
            color: #ffffff;
        }

        body.dark-mode .amount-btn {
            background-color: #218838;
        }

        body.dark-mode .contributor-btn {
            background-color: #138496;
        }

        body.dark-mode .receiver-btn {
            background-color: #e0a800;
            color: #ffffff;
        }

        body.dark-mode .graph-btn {
            background-color: #5a6268;
        }

        /* Dropdown in dark mode */
        body.dark-mode .styled-dropdown {
            background-color: #2c2c2c;
            color: #ffffff;
            border: 1px solid #555;
        }

        @media (max-width: 768px) {

            .header {
                flex-direction: column;
                padding: 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            .logo {
                height: 40px;
                width: 40px;
            }

            .footer {
                font-size: 14px;
            }

            table,
            th,
            td {
                font-size: 12px;
                padding: 8px;
            }

            input,
            button {
                padding: 8px;
                font-size: 14px;
            }

            canvas {
                height: 300px !important;
                /* Reduce height for smaller screens */
            }

            .chart-controls {
                flex-direction: column;
                gap: 10px;
            }

            .styled-btn {
                width: 100%;
            }

            .styled-dropdown {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- Wrapper for full-page layout -->
    <div class="page-wrapper">
        <!-- Header Section -->
        <header class="header">
            <a href="/" class="logo">
                <img src="/assets/logo.png?v=1.0" alt="Logo" class="logo">
            </a>
            <h1>Amount Distribution Tool</h1>
        </header>

        <!-- Theme Toggle Icon -->
        <div id="themeToggleBtn" class="theme-icon" title="Toggle Dark Mode">
            <i class="fas fa-moon" id="themeIcon"></i>
        </div>

        <!-- Main Container -->
        <main class="main-container">
            <div id="errorMessage" style="color: red; display: none;"></div>
            <!-- Form Section -->
            <!-- Amount Input Section -->
            <div class="section" id="amountSection">
                <h2>Total Amount (₹)</h2>
                <div class="inline-inputs">
                    <input type="number" id="totalAmount" placeholder="Enter the total amount">
                    <button id="addAmount" class="styled-btn amount-btn">Add Amount</button>

                </div>
                <p id="amountPreview"></p>
            </div>

            <!-- Contributor Group Section -->
            <div class="section" id="contributorSection">
                <h2>Contributor Group</h2>
                <!-- Success Message -->
                <p id="contributorSuccessMessage" class="success-message" style="display: none;">
                    Contributor group added successfully!
                </p>
                <div class="inline-inputs">
                    <!-- Group Input Fields -->
                    <input type="text" id="contributorGroupName" placeholder="Contributor Group Name" required>
                    <input type="number" id="contributorPercentage" placeholder="Percentage (%)" required>
                    <input type="text" id="contributorMembers" placeholder="Members (comma-separated)" required>

                    <!-- Hidden Input Field to store edit index -->
                    <input type="hidden" id="editIndex" value="">

                    <!-- Action Buttons -->
                    <button id="addContributorGroup" class="styled-btn contributor-btn">Add Contributor Group</button>
                    <div id="errorMessage" style="color: red; display: none;"></div>
                    <button id="updateContributorGroup" class="styled-btn contributor-btn" style="display: none;">Update
                        Contributor Group</button>
                </div>
                <p id="contributorMessage" class="success-message"></p>
                <table id="contributorPreviewTable">
                    <thead>
                        <tr>
                            <th>Group Name</th>
                            <th>Percentage (%)</th>
                            <th>Members</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="contributorPreviewBody"></tbody>
                </table>
            </div>

            <!-- Receiver Group Section -->
            <div class="section" id="receiverSection">
                <h2>Receiver Group</h2>
                <!-- Success Message -->
                <p id="receiverSuccessMessage" class="success-message" style="display: none;">
                    Receiver group added successfully!
                </p>
                <div class="inline-inputs">
                    <!-- Group Input Fields -->
                    <input type="text" id="receiverGroupName" placeholder="Receiver Group Name" required>
                    <input type="number" id="receiverPercentage" placeholder="Percentage (%)" required>
                    <input type="text" id="receiverMembers" placeholder="Members (comma-separated)" required>

                    <!-- Hidden Input Field to store edit index -->
                    <input type="hidden" id="editIndex" value="">

                    <!-- Action Buttons -->
                    <button id="addReceiverGroup" class="styled-btn receiver-btn">Add Receiver Group</button>
                    <div id="errorMessage" style="color: red; display: none;"></div>
                    <button id="updateReceiverGroup" class="styled-btn receiver-btn" style="display: none;">Update
                        Receiver
                        Group</button>
                </div>
                <p id="receiverMessage" class="success-message"></p>
                <table id="receiverPreviewTable">
                    <thead>
                        <tr>
                            <th>Group Name</th>
                            <th>Percentage (%)</th>
                            <th>Members</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Call-to-Action Buttons -->
            <!-- CTA Section for Calculate and Reset -->
            <div class="section cta-section">
                <button id="calculate" class="styled-btn calculate-btn">Calculate</button>
                <button id="resetPage" class="styled-btn reset-btn">Reset</button>
            </div>


            <!-- Export Data Section -->
            <div class="export-section">
                <h3>Export Data</h3>
                <div class="export-options">
                    <div class="export-icon" id="exportPNG" aria-label="Export to PNG" title="Export to PNG">
                        <i class="fas fa-file-image"></i>
                        <span>PNG</span>
                    </div>
                    <div class="export-icon" id="exportPDF" aria-label="Export to PDF" title="Export to PDF">
                        <i class="fas fa-file-pdf"></i>
                        <span>PDF</span>
                    </div>
                    <div class="export-icon" id="exportCSV" aria-label="Export to CSV" title="Export to CSV">
                        <i class="fas fa-file-csv"></i>
                        <span>CSV</span>
                    </div>
                    <div class="export-icon" id="exportExcel" aria-label="Export to Excel" title="Export to Excel">
                        <i class="fas fa-file-excel"></i>
                        <span>Excel</span>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="section" id="resultSection">
                <!-- Search Filter Input -->
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Search..." onkeyup="filterTable()">
                </div>

                <h2>Results: Receiver's Perspective</h2>
                <div class="matrix-table-wrapper">
                    <table id="matrixTableReceiver">
                        <thead>
                            <tr>
                                <th>Receiver Group / Member</th>
                                <th>Contributor Group / Member</th>
                                <th>Amount (₹)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <h2>Results: Contributor's Perspective</h2>
                <div class="matrix-table-wrapper">
                    <table id="matrixTableContributor">
                        <thead>
                            <tr>
                                <th>Contributor Group / Member</th>
                                <th>Receiver Group / Member</th>
                                <th>Amount (₹)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>


            <!-- Chart Section -->
            <div class="chart-container">
                <h2>Charts</h2>
                <!-- Flex container for dropdown and button -->
                <div class="chart-controls">
                    <select id="chartType" class="styled-dropdown">
                        <option value="bar">Bar Chart</option>
                        <option value="line">Line Chart</option>
                        <option value="pie">Pie Chart</option>
                        <option value="grouped-bar">Grouped Bar Chart</option>
                    </select>

                    <button id="showGraphs" class="styled-btn graph-btn">Show Graphs</button>
                </div>
            </div>

            <!-- Chart Section -->
            <!-- Chart Section for Receiver's Perspective -->
            <div class="chart-section" style="display: none;" id="chartSectionReceiver">
                <h2>Receiver's Perspective Chart</h2>
                <canvas id="receiverChart"></canvas>
            </div>

            <!-- Chart Section for Contributor's Perspective -->
            <div class="chart-section" style="display: none;" id="chartSectionContributor">
                <h2>Contributor's Perspective Chart</h2>
                <canvas id="contributorChart"></canvas>
            </div>
        </main>
        <!-- Footer -->
        <footer class="footer">
            <p>© 2025 Amount Distribution Tool. All rights reserved.</p>
        </footer>
    </div>
    <script>
        let contributors = [];
        let receivers = [];

        // Add Amount CTA
        document.getElementById("addAmount").addEventListener("click", function () {
            const totalAmount = parseFloat(document.getElementById("totalAmount").value);
            if (isNaN(totalAmount) || totalAmount <= 0) {
                showError("Please enter a valid total amount!");
                return;
            }
            document.getElementById("amountPreview").textContent = `Amount added: ₹${totalAmount}`;
        });

        // Restrict input in the members field to valid characters only
        document.getElementById("contributorMembers").addEventListener("input", function () {
            this.value = this.value.replace(/[^A-Za-z0-9,]/g, '');
        });
        // Add Contributor Group CTA
        document.getElementById("addContributorGroup").addEventListener("click", function () {
            const name = document.getElementById("contributorGroupName").value;
            const percentage = parseFloat(document.getElementById("contributorPercentage").value);
            const members = document.getElementById("contributorMembers").value.split(",");

            if (!name || isNaN(percentage) || percentage <= 0 || !members.length) {
                showError("Please fill out all contributor fields!");
                return;
            }

            // Check if the input matches the valid pattern
            if (!/^[A-Za-z0-9,]+$/.test(members)) {
                showError("Invalid input! Only letters, numbers, and commas are allowed.");
                return;
            }

            // Proceed with form submission
            console.log("Contributor group added successfully.");

            contributors.push({ name, percentage, members });
            // Clear input fields
            clearContributorFields();
            // Refresh the preview table
            displayContributorGroups();
            // Show success message
            const successMessage = document.getElementById("contributorSuccessMessage");
            successMessage.style.display = "block";

            // Hide the message after 3 seconds
            setTimeout(function () {
                successMessage.style.display = "none";
            }, 3000);
        });


        // Restrict input in the members field to valid characters only
        document.getElementById("receiverMembers").addEventListener("input", function () {
            this.value = this.value.replace(/[^A-Za-z0-9,]/g, '');
        });
        // Add Receiver Group CTA
        document.getElementById("addReceiverGroup").addEventListener("click", function () {
            const name = document.getElementById("receiverGroupName").value;
            const percentage = parseFloat(document.getElementById("receiverPercentage").value);
            const members = document.getElementById("receiverMembers").value.split(",");

            if (!name || isNaN(percentage) || percentage <= 0 || !members.length) {
                showError("Please fill out all receiver fields!");
                return;
            }

            // Check if the input matches the valid pattern
            if (!/^[A-Za-z0-9,]+$/.test(members)) {
                showError("Invalid input! Only letters, numbers, and commas are allowed.");
                return;
            }

            receivers.push({ name, percentage, members });

            // Clear input fields
            clearReceiverFields();

            // Refresh the preview table
            displayReceiverGroups();

            // Show success message
            const successMessage = document.getElementById("receiverSuccessMessage");
            successMessage.style.display = "block";

            // Hide the message after 3 seconds
            setTimeout(function () {
                successMessage.style.display = "none";
            }, 3000);
        });

        // Send data to backend on Calculate button click
        document.getElementById("calculate").addEventListener("click", function () {
            const totalAmount = parseFloat(document.getElementById("totalAmount").value);
            if (isNaN(totalAmount) || totalAmount <= 0) {
                showError("Please enter a valid total amount!");
                return;
            }

            fetch(`${window.location.origin}/calculate`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    total_amount: totalAmount,
                    contributors: contributors,
                    receivers: receivers
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayMatrixReceiver(data);
                    displayMatrixContributor(data);
                })
                .catch(error => {
                    console.error("Error:", error);
                });

        });

        // Display Matrix Receiver View Results
        function displayMatrixReceiver(data) {
            const tbody = document.getElementById("matrixTableReceiver").querySelector("tbody");
            tbody.innerHTML = "";

            data.matrix.forEach(group => {
                const groupHeaderRow = document.createElement("tr");
                groupHeaderRow.classList.add("matrix-group-header");
                groupHeaderRow.innerHTML = `<td colspan="3">Receiver Group: ${group.group_name}</td>`;
                tbody.appendChild(groupHeaderRow);

                group.members.forEach(member => {
                    const memberRow = document.createElement("tr");
                    memberRow.classList.add("matrix-member-row");
                    memberRow.innerHTML = `<td>${member.receiver}</td><td>Total</td><td>₹${member.subtotal.toFixed(2)}</td>`;
                    tbody.appendChild(memberRow);

                    member.details.forEach(detail => {
                        const detailRow = document.createElement("tr");
                        detailRow.innerHTML = `<td></td><td>${detail.contributor}</td><td>₹${detail.amount.toFixed(2)}</td>`;
                        tbody.appendChild(detailRow);
                    });
                });

                const totalRow = document.createElement("tr");
                totalRow.classList.add("matrix-total-row");
                totalRow.innerHTML = `<td colspan="2">Group Total</td><td>₹${group.group_total.toFixed(2)}</td>`;
                tbody.appendChild(totalRow);
            });

            const overallRow = document.createElement("tr");
            overallRow.classList.add("matrix-total-row");
            overallRow.innerHTML = `<td colspan="2">Overall Total</td><td>₹${data.overall_total.toFixed(2)}</td>`;
            tbody.appendChild(overallRow);
        }

        // Display Matrix Contributor View Results
        function displayMatrixContributor(data) {
            const tbody = document.getElementById("matrixTableContributor").querySelector("tbody");
            tbody.innerHTML = "";

            const contributorData = {};
            data.matrix.forEach(group => {
                group.members.forEach(member => {
                    member.details.forEach(detail => {
                        if (!contributorData[detail.contributor]) {
                            contributorData[detail.contributor] = [];
                        }

                        contributorData[detail.contributor].push({
                            receiverGroup: group.group_name,
                            receiverMember: member.receiver,
                            amount: detail.amount
                        });
                    });
                });
            });

            for (const [contributor, contributions] of Object.entries(contributorData)) {
                const contributorHeaderRow = document.createElement("tr");
                contributorHeaderRow.classList.add("matrix-group-header");
                contributorHeaderRow.innerHTML = `<td colspan="3">Contributor: ${contributor}</td>`;
                tbody.appendChild(contributorHeaderRow);

                let contributorTotal = 0;
                contributions.forEach(entry => {
                    const contributionRow = document.createElement("tr");
                    contributionRow.classList.add("matrix-member-row");
                    contributionRow.innerHTML = `<td></td><td>${entry.receiverMember}</td><td>₹${entry.amount.toFixed(2)}</td>`;
                    tbody.appendChild(contributionRow);
                    contributorTotal += entry.amount;
                });

                const totalRow = document.createElement("tr");
                totalRow.classList.add("matrix-total-row");
                totalRow.innerHTML = `<td colspan="2">Contributor Total</td><td>₹${contributorTotal.toFixed(2)}</td>`;
                tbody.appendChild(totalRow);
            }
        }


        // Get Matix Data        
        function getMatrixData() {
            const matrix = [];

            // Read data from Receiver's table
            const receiverTable = document.getElementById("matrixTableReceiver").querySelector("tbody").rows;
            let currentGroup = null;

            Array.from(receiverTable).forEach(row => {
                const cells = row.cells;

                // Check if the row has cells to avoid undefined errors
                if (!cells || cells.length === 0) return;

                // Group Header Row (with colspan)
                if (row.classList.contains("matrix-group-header")) {
                    currentGroup = { group_name: cells[0].textContent.replace("Receiver Group: ", ""), members: [] };
                    matrix.push(currentGroup);
                }

                // Receiver Member Row
                else if (cells.length >= 3 && cells[1].textContent === "Total") {
                    currentGroup.members.push({
                        receiver: cells[0].textContent,
                        subtotal: parseFloat(cells[2].textContent.replace("₹", "").replace(",", "").trim()),
                        details: []
                    });
                }

                // Contributor Details Row
                else if (cells.length >= 3 && cells[1].textContent) {
                    const lastMember = currentGroup.members[currentGroup.members.length - 1];
                    if (lastMember) {
                        lastMember.details.push({
                            contributor: cells[1].textContent,
                            amount: parseFloat(cells[2].textContent.replace("₹", "").replace(",", "").trim())
                        });
                    }
                }
            });

            return { matrix };
        }


        // Clear field Post Add Contrinbutor CTA
        function clearContributorFields() {
            document.getElementById("contributorGroupName").value = "";
            document.getElementById("contributorPercentage").value = "";
            document.getElementById("contributorMembers").value = "";
        }

        // Clear field Post Add Receiever CTA 
        function clearReceiverFields() {
            document.getElementById("receiverGroupName").value = "";
            document.getElementById("receiverPercentage").value = "";
            document.getElementById("receiverMembers").value = "";
        }

        // Display Contributor group in preview table   
        function displayContributorGroups() {
            const tbody = document.getElementById("contributorPreviewTable").querySelector("tbody");
            tbody.innerHTML = "";

            contributors.forEach((group, index) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td>${group.name}</td>
            <td>${group.percentage}</td>
            <td>${group.members.join(", ")}</td>
            <td>
                <a href="#" class="contributor-edit-link" data-index="${index}">Edit</a> |
                <a href="#" class="contributor-delete-link" data-index="${index}">Delete</a>
            </td>
        `;
                tbody.appendChild(tr);
            });
        }

        // Added an event listener for Edit links. When clicked, it populates the input fields for editing: (Contributor Group)
        document.addEventListener("click", function (event) {
            if (event.target.classList.contains("contributor-edit-link")) {
                event.preventDefault();

                const index = event.target.getAttribute("data-index");
                const group = contributors[index];

                // Populate input fields
                document.getElementById("contributorGroupName").value = group.name;
                document.getElementById("contributorPercentage").value = group.percentage;
                document.getElementById("contributorMembers").value = group.members.join(", ");

                // Set the index for updating
                document.getElementById("editIndex").value = index;

                // Show update button and hide add button
                document.getElementById("addContributorGroup").style.display = "none";
                document.getElementById("updateContributorGroup").style.display = "block";
            }
        });

        // Added a handler to save the updated group details (Contributor Group)
        document.getElementById("updateContributorGroup").addEventListener("click", function () {
            const index = document.getElementById("editIndex").value;

            // Update the group data
            contributors[index] = {
                name: document.getElementById("contributorGroupName").value,
                percentage: parseFloat(document.getElementById("contributorPercentage").value),
                members: document.getElementById("contributorMembers").value.split(",").map(m => m.trim())
            };

            // Refresh the preview and reset the form
            displayContributorGroups();
            clearContributorFields();

            // Switch buttons
            document.getElementById("addContributorGroup").style.display = "block";
            document.getElementById("updateContributorGroup").style.display = "none";
        });

        // Added a handler for deleting a group: (Contributor Group)
        document.addEventListener("click", function (event) {
            if (event.target.classList.contains("contributor-delete-link")) {
                event.preventDefault();

                const index = event.target.getAttribute("data-index");

                // Ask for confirmation before deleting
                if (confirm("Are you sure you want to delete this Contributor group?")) {
                    // Remove the group and refresh the preview
                    contributors.splice(index, 1);
                    displayContributorGroups();
                }
            }
        });

        // Display Receiver group in preview table     
        function displayReceiverGroups() {
            const tbody = document.getElementById("receiverPreviewTable").querySelector("tbody");
            tbody.innerHTML = "";

            receivers.forEach((group, index) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${group.name}</td>
                    <td>${group.percentage}</td>
                    <td>${group.members.join(", ")}</td>
            <td>
                <a href="#" class="receiver-edit-link" data-index="${index}">Edit</a> |
                <a href="#" class="receiver-delete-link" data-index="${index}">Delete</a>
            </td>
            `;
                tbody.appendChild(tr);
            });
        }

        // Added an event listener for Edit links. When clicked, it populates the input fields for editing: (Receiver Group)
        document.addEventListener("click", function (event) {
            if (event.target.classList.contains("receiver-edit-link")) {
                event.preventDefault();

                const index = event.target.getAttribute("data-index");
                const group = receivers[index];

                // Populate input fields
                document.getElementById("receiverGroupName").value = group.name;
                document.getElementById("receiverPercentage").value = group.percentage;
                document.getElementById("receiverMembers").value = group.members.join(", ");

                // Set the index for updating
                document.getElementById("editIndex").value = index;

                // Show update button and hide add button
                document.getElementById("addReceiverGroup").style.display = "none";
                document.getElementById("updateReceiverGroup").style.display = "block";
            }
        });

        // Added a handler to save the updated group details (Receiver Group)
        document.getElementById("updateReceiverGroup").addEventListener("click", function () {
            const index = document.getElementById("editIndex").value;

            // Update the group data
            receivers[index] = {
                name: document.getElementById("receiverGroupName").value,
                percentage: parseFloat(document.getElementById("receiverPercentage").value),
                members: document.getElementById("receiverMembers").value.split(",").map(m => m.trim())
            };

            // Refresh the preview and reset the form
            displayReceiverGroups();
            clearReceiverFields();

            // Switch buttons
            document.getElementById("addReceiverGroup").style.display = "block";
            document.getElementById("updateReceiverGroup").style.display = "none";
        });

        // Added a handler for deleting a group: (Receiver Group)
        document.addEventListener("click", function (event) {
            if (event.target.classList.contains("receiver-delete-link")) {
                event.preventDefault();

                const index = event.target.getAttribute("data-index");

                // Ask for confirmation before deleting
                if (confirm("Are you sure you want to delete this Receiver group?")) {
                    // Remove the group and refresh the preview
                    receivers.splice(index, 1);
                    displayReceiverGroups();
                }
            }
        });

        // Function to clean and extract text content
        function trimText(text) {
            return text ? text.trim() : "";
        }

        let contributorChartInstance = null;
        let receiverChartInstance = null;

        function setChartHeight(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (window.innerWidth < 768) {
                canvas.style.height = '300px';
            } else {
                canvas.style.height = '500px';
            }
        }

        // Function to render the charts
        function renderCharts(chartType = 'bar') {
            // --- Destroy existing charts if they exist ---
            if (contributorChartInstance) {
                contributorChartInstance.destroy();
            }
            if (receiverChartInstance) {
                receiverChartInstance.destroy();
            }
            // Set responsive heights
            setChartHeight('receiverChart');
            setChartHeight('contributorChart');

            // --- Contributors Perspective Chart ---
            const receiverRows = document.getElementById("matrixTableReceiver").querySelector("tbody").rows;

            const receivers = [];
            const contributors = new Set();
            const contributorData = {};

            Array.from(receiverRows).forEach(row => {
                const cells = row.cells;
                if (cells.length === 3) {
                    const receiver = trimText(cells[0].textContent);
                    const contributor = trimText(cells[1].textContent);
                    const amount = parseFloat(trimText(cells[2].textContent).replace(/₹/, ''));

                    if (!receivers.includes(receiver)) receivers.push(receiver);
                    contributors.add(contributor);

                    if (!contributorData[receiver]) contributorData[receiver] = {};
                    contributorData[receiver][contributor] = (contributorData[receiver][contributor] || 0) + amount;
                }
            });

            const contributorsArray = Array.from(contributors);

            // Datasets for Contributors Perspective
            const contributorDatasets = contributorsArray.map((contributor, index) => ({
                label: contributor,
                data: receivers.map(receiver => contributorData[receiver][contributor] || 0),
                backgroundColor: `rgba(${(index * 60) % 255}, ${(index * 90) % 255}, 180, 0.5)`,
                borderColor: `rgba(${(index * 60) % 255}, ${(index * 90) % 255}, 180, 1)`,
                borderWidth: 1
            }));

            // --- Render Contributors Perspective Chart ---
            const contributorCtx = document.getElementById('contributorChart').getContext('2d');
            contributorChartInstance = new Chart(contributorCtx, {
                type: chartType === 'grouped-bar' ? 'bar' : chartType,
                data: {
                    labels: receivers,  // Your parsed receiver data
                    datasets: contributorDatasets  // Your parsed contributor data
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    return `${tooltipItem.dataset.label} to ${tooltipItem.label}: ₹${tooltipItem.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: chartType === 'pie' ? {} : {
                        x: {
                            stacked: chartType === 'bar',
                            title: { display: true, text: 'Receivers' }
                        },
                        y: {
                            stacked: chartType === 'bar',
                            beginAtZero: true,
                            title: { display: true, text: 'Amount (₹)' }
                        }
                    }
                }
            });

            // --- Receivers Perspective Chart ---
            const receiverDatasets = receivers.map((receiver, index) => ({
                label: receiver,
                data: contributorsArray.map(contributor => contributorData[receiver][contributor] || 0),
                backgroundColor: `rgba(${(index * 70) % 255}, ${(index * 110) % 255}, 150, 0.5)`,
                borderColor: `rgba(${(index * 70) % 255}, ${(index * 110) % 255}, 150, 1)`,
                borderWidth: 1
            }));

            const receiverCtx = document.getElementById('receiverChart').getContext('2d');
            receiverChartInstance = new Chart(receiverCtx, {
                type: chartType === 'grouped-bar' ? 'bar' : chartType,
                data: {
                    labels: contributorsArray,  // Your parsed contributor data
                    datasets: receiverDatasets  // Your parsed receiver data
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    return `${tooltipItem.dataset.label} from ${tooltipItem.label}: ₹${tooltipItem.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: chartType === 'pie' ? {} : {
                        x: {
                            stacked: chartType === 'bar',
                            title: { display: true, text: 'Contributors' }
                        },
                        y: {
                            stacked: chartType === 'bar',
                            beginAtZero: true,
                            title: { display: true, text: 'Amount (₹)' }
                        }
                    }
                }
            });
        }


        // Event listener for the "Show Graphs" button
        document.getElementById("showGraphs").addEventListener("click", function () {
            // Show the chart sections
            document.getElementById("chartSectionReceiver").style.display = "block";
            document.getElementById("chartSectionContributor").style.display = "block";

            // Render the charts with default chart type
            renderCharts('bar');
        });

        // Event listener to handle chart type selection
        document.getElementById("chartType").addEventListener("change", function () {
            const chartType = this.value;

            // Re-render charts with the selected type
            renderCharts(chartType);
        });

        // PNG Export
        document.getElementById("exportPNG").addEventListener("click", function () {
            // Export Receiver's Perspective Table as PNG
            const receiverTable = document.getElementById("matrixTableReceiver");
            html2canvas(receiverTable, { scale: 2 }).then(canvas => {
                const link = document.createElement("a");
                link.href = canvas.toDataURL("image/png");
                link.download = "receiver_perspective.png";
                link.click();
            });

            // Export Contributor's Perspective Table as PNG
            const contributorTable = document.getElementById("matrixTableContributor");
            html2canvas(contributorTable, { scale: 2 }).then(canvas => {
                const link = document.createElement("a");
                link.href = canvas.toDataURL("image/png");
                link.download = "contributor_perspective.png";
                link.click();
            });
        });

        // Export PDF Button Event Listener
        document.getElementById("exportPDF").addEventListener("click", function () {
            fetch("/export_pdf", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(getMatrixData())
            })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "amount_distribution.pdf";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                });
        });

        // Export CSV Button Event Listener
        document.getElementById("exportCSV").addEventListener("click", function () {
            fetch("/export_csv", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(getMatrixData())
            })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "amount_distribution.csv";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                });
        });

        // Export Excel Button Event Listener
        document.getElementById("exportExcel").addEventListener("click", function () {
            // Gather data from Receiver's table
            const receiverData = [["Receiver Group", "Receiver Member", "Contributor", "Amount (₹)"]];
            const receiverRows = document.getElementById("matrixTableReceiver").querySelector("tbody").rows;

            Array.from(receiverRows).forEach(row => {
                const cells = row.cells;
                if (cells.length === 3) {
                    receiverData.push([cells[0].textContent, cells[1].textContent, cells[2].textContent]);
                }
            });

            // Gather data from Contributor's table
            const contributorData = [["Contributor", "Receiver Group / Member", "Amount (₹)"]];
            const contributorRows = document.getElementById("matrixTableContributor").querySelector("tbody").rows;

            Array.from(contributorRows).forEach(row => {
                const cells = row.cells;
                if (cells.length === 3) {
                    contributorData.push([cells[0].textContent, cells[1].textContent, cells[2].textContent]);
                }
            });

            // Create Excel workbook and sheets
            const wb = XLSX.utils.book_new();

            // Add Receiver's Perspective sheet
            const wsReceiver = XLSX.utils.aoa_to_sheet(receiverData);
            XLSX.utils.book_append_sheet(wb, wsReceiver, "Receiver's Perspective");

            // Add Contributor's Perspective sheet
            const wsContributor = XLSX.utils.aoa_to_sheet(contributorData);
            XLSX.utils.book_append_sheet(wb, wsContributor, "Contributor's Perspective");

            // Export the workbook
            XLSX.writeFile(wb, "amount_distribution.xlsx");
        });

        // Reset Button Event Listener
        document.addEventListener("DOMContentLoaded", function () {
            // Attach the reset button event listener
            const resetButton = document.getElementById("resetPage");

            if (resetButton) {
                resetButton.addEventListener("click", function () {
                    console.log("Reset button clicked!");

                    // Scroll to the top of the page
                    window.scrollTo(0, 0);

                    // Reload the page to reset all fields, tables, and data
                    location.reload();
                });
            } else {
                console.error("Reset button not found!");
            }
        });
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';

            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }


        // Get the theme toggle button and icon
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const themeIcon = document.getElementById('themeIcon');

        // Check if dark mode is enabled in local storage
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            themeIcon.classList.replace('fa-moon', 'fa-sun');
        }

        // Event listener to toggle dark mode
        themeToggleBtn.addEventListener('click', function () {
            document.body.classList.toggle('dark-mode');
            document.querySelectorAll('table').forEach(table => table.classList.toggle('dark-mode'));

            // Toggle the icon between moon and sun
            if (document.body.classList.contains('dark-mode')) {
                themeIcon.classList.replace('fa-moon', 'fa-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.classList.replace('fa-sun', 'fa-moon');
                localStorage.setItem('theme', 'light');
            }
        });

        function filterTable() {
            const filter = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('table tbody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        }

        function saveData() {
            const data = {
                totalAmount: document.getElementById('totalAmount').value,
                contributors: document.getElementById('contributorsInput').value,
                receivers: document.getElementById('receiversInput').value
            };
            localStorage.setItem('appData', JSON.stringify(data));
        }

        function loadData() {
            const data = JSON.parse(localStorage.getItem('appData'));
            if (data) {
                document.getElementById('totalAmount').value = data.totalAmount;
                document.getElementById('contributorsInput').value = data.contributors;
                document.getElementById('receiversInput').value = data.receivers;
            }
        }

        // Call loadData on page load
        window.onload = loadData;

    </script>
</body>

</html>