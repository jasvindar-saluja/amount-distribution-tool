<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amount Distribution Tool</title>
    <!-- Font Awesome Icons (Add here) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f4f4f4;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
        }

        label {
            font-weight: bold;
            display: block;
            margin: 10px 0 5px;
        }

        input,
        button {
            width: 100%;
            padding: 10px;
            margin: 5px 0 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .inline-inputs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .inline-input {
            flex: 1;
        }

        .section {
            margin-top: 20px;
            padding: 15px;
            background: #fafafa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }

        table,
        th,
        td {
            border: 1px solid #ddd;
        }

        th,
        td {
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: #f4f4f4;
            font-weight: bold;
        }

        .matrix-group-header {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            text-align: center;
        }

        .matrix-member-row {
            background-color: #f9f9f9;
        }

        .matrix-member-row:nth-child(odd) {
            background-color: #e9ecef;
        }

        .matrix-total-row {
            background-color: #d1ecf1;
            font-weight: bold;
            border-top: 2px solid #007bff;
        }

        .matrix-table-wrapper {
            overflow-x: auto;
        }

        .message {
            color: green;
            font-weight: bold;
            margin-top: 5px;
        }

        .export-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .export-icons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }

        .export-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: #007bff;
            font-size: 1.5rem;
        }

        .export-icon:hover {
            color: #0056b3;
        }

        .export-icon span {
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .export-icon i {
            font-size: 2rem;
        }

        @media (max-width: 768px) {

            table,
            th,
            td {
                font-size: 12px;
                padding: 8px;
            }

            input,
            button {
                padding: 8px;
                font-size: 14px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Amount Distribution Tool</h1>

        <!-- Amount Input Section -->
        <div class="section" id="amountSection">
            <h2>Total Amount (₹)</h2>
            <div class="inline-inputs">
                <input type="number" id="totalAmount" placeholder="Enter the total amount">
                <button id="addAmount">Add Amount</button>
            </div>
            <p id="amountPreview"></p>
        </div>

        <!-- Contributor Group Section -->
        <div class="section" id="contributorSection">
            <h2>Contributor Group</h2>
            <div class="inline-inputs">
                <input type="text" id="contributorGroupName" placeholder="Contributor Group Name">
                <input type="number" id="contributorPercentage" placeholder="Percentage (%)">
                <input type="text" id="contributorMembers" placeholder="Members (comma-separated)">
                <button id="addContributorGroup">Add Contributor Group</button>
            </div>
            <p id="contributorMessage" class="message"></p>
            <table id="contributorPreviewTable">
                <thead>
                    <tr>
                        <th>Group Name</th>
                        <th>Percentage (%)</th>
                        <th>Members</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Receiver Group Section -->
        <div class="section" id="receiverSection">
            <h2>Receiver Group</h2>
            <div class="inline-inputs">
                <input type="text" id="receiverGroupName" placeholder="Receiver Group Name">
                <input type="number" id="receiverPercentage" placeholder="Percentage (%)">
                <input type="text" id="receiverMembers" placeholder="Members (comma-separated)">
                <button id="addReceiverGroup">Add Receiver Group</button>
            </div>
            <p id="receiverMessage" class="message"></p>
            <table id="receiverPreviewTable">
                <thead>
                    <tr>
                        <th>Group Name</th>
                        <th>Percentage (%)</th>
                        <th>Members</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Call-to-Action Buttons -->
        <div class="cta-buttons">
            <button id="calculate">Calculate</button>
            <button id="resetPage">Reset</button>
        </div>

        <!-- Export Data Section -->
        <div class="export-section">
            <h3>Export Data</h3>
            <div class="export-icons">
                <div class="export-icon" id="exportPNG">
                    <i class="fas fa-file-image"></i>
                    <span>PNG</span>
                </div>
                <div class="export-icon" id="exportPDF">
                    <i class="fas fa-file-pdf"></i>
                    <span>PDF</span>
                </div>
                <div class="export-icon" id="exportCSV">
                    <i class="fas fa-file-csv"></i>
                    <span>CSV</span>
                </div>
                <div class="export-icon" id="exportExcel">
                    <i class="fas fa-file-excel"></i>
                    <span>Excel</span>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="section" id="resultSection">
            <h2>Results: Receiver's Perspective</h2>
            <div class="matrix-table-wrapper">
                <table id="matrixTableReceiver">
                    <thead>
                        <tr>
                            <th>Receiver Group / Member</th>
                            <th>Contributor Group / Member</th>
                            <th>Amount (₹)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <h2>Results: Contributor's Perspective</h2>
            <div class="matrix-table-wrapper">
                <table id="matrixTableContributor">
                    <thead>
                        <tr>
                            <th>Contributor Group / Member</th>
                            <th>Receiver Group / Member</th>
                            <th>Amount (₹)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let contributors = [];
        let receivers = [];

        // Add Amount
        document.getElementById("addAmount").addEventListener("click", function () {
            const totalAmount = parseFloat(document.getElementById("totalAmount").value);
            if (isNaN(totalAmount) || totalAmount <= 0) {
                alert("Please enter a valid amount!");
                return;
            }
            document.getElementById("amountPreview").textContent = `Amount added: ₹${totalAmount}`;
        });

        // Add Contributor Group
        document.getElementById("addContributorGroup").addEventListener("click", function () {
            const name = document.getElementById("contributorGroupName").value;
            const percentage = parseFloat(document.getElementById("contributorPercentage").value);
            const members = document.getElementById("contributorMembers").value.split(",");

            if (!name || isNaN(percentage) || percentage <= 0 || !members.length) {
                alert("Please fill out all contributor fields!");
                return;
            }

            contributors.push({ name, percentage, members });
            clearContributorFields();
            displayContributorGroups();
            document.getElementById("contributorMessage").textContent = "Contributor group added successfully!";
        });

        // Add Receiver Group
        document.getElementById("addReceiverGroup").addEventListener("click", function () {
            const name = document.getElementById("receiverGroupName").value;
            const percentage = parseFloat(document.getElementById("receiverPercentage").value);
            const members = document.getElementById("receiverMembers").value.split(",");

            if (!name || isNaN(percentage) || percentage <= 0 || !members.length) {
                alert("Please fill out all receiver fields!");
                return;
            }

            receivers.push({ name, percentage, members });
            clearReceiverFields();
            displayReceiverGroups();
            document.getElementById("receiverMessage").textContent = "Receiver group added successfully!";
        });

        // Send data to backend on Calculate button click
        document.getElementById("calculate").addEventListener("click", function () {
            const totalAmount = parseFloat(document.getElementById("totalAmount").value);
            if (isNaN(totalAmount) || totalAmount <= 0) {
                alert("Please enter a valid total amount!");
                return;
            }

            fetch("/calculate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    total_amount: totalAmount,
                    contributors: contributors,
                    receivers: receivers
                })
            })
                .then(response => response.json())
                .then(data => {
                    displayMatrixReceiver(data);
                    displayMatrixContributor(data);
                });
        });

        // Display Matrix Receiver View Results
        function displayMatrixReceiver(data) {
            const tbody = document.getElementById("matrixTableReceiver").querySelector("tbody");
            tbody.innerHTML = "";

            data.matrix.forEach(group => {
                const groupHeaderRow = document.createElement("tr");
                groupHeaderRow.classList.add("matrix-group-header");
                groupHeaderRow.innerHTML = `<td colspan="3">Receiver Group: ${group.group_name}</td>`;
                tbody.appendChild(groupHeaderRow);

                group.members.forEach(member => {
                    const memberRow = document.createElement("tr");
                    memberRow.classList.add("matrix-member-row");
                    memberRow.innerHTML = `<td>${member.receiver}</td><td>Total</td><td>₹${member.subtotal.toFixed(2)}</td>`;
                    tbody.appendChild(memberRow);

                    member.details.forEach(detail => {
                        const detailRow = document.createElement("tr");
                        detailRow.innerHTML = `<td></td><td>${detail.contributor}</td><td>₹${detail.amount.toFixed(2)}</td>`;
                        tbody.appendChild(detailRow);
                    });
                });

                const totalRow = document.createElement("tr");
                totalRow.classList.add("matrix-total-row");
                totalRow.innerHTML = `<td colspan="2">Group Total</td><td>₹${group.group_total.toFixed(2)}</td>`;
                tbody.appendChild(totalRow);
            });

            const overallRow = document.createElement("tr");
            overallRow.classList.add("matrix-total-row");
            overallRow.innerHTML = `<td colspan="2">Overall Total</td><td>₹${data.overall_total.toFixed(2)}</td>`;
            tbody.appendChild(overallRow);
        }

        // Display Matrix Contributor View Results
        function displayMatrixContributor(data) {
            const tbody = document.getElementById("matrixTableContributor").querySelector("tbody");
            tbody.innerHTML = "";

            const contributorData = {};
            data.matrix.forEach(group => {
                group.members.forEach(member => {
                    member.details.forEach(detail => {
                        if (!contributorData[detail.contributor]) {
                            contributorData[detail.contributor] = [];
                        }

                        contributorData[detail.contributor].push({
                            receiverGroup: group.group_name,
                            receiverMember: member.receiver,
                            amount: detail.amount
                        });
                    });
                });
            });

            for (const [contributor, contributions] of Object.entries(contributorData)) {
                const contributorHeaderRow = document.createElement("tr");
                contributorHeaderRow.classList.add("matrix-group-header");
                contributorHeaderRow.innerHTML = `<td colspan="3">Contributor: ${contributor}</td>`;
                tbody.appendChild(contributorHeaderRow);

                let contributorTotal = 0;
                contributions.forEach(entry => {
                    const contributionRow = document.createElement("tr");
                    contributionRow.classList.add("matrix-member-row");
                    contributionRow.innerHTML = `<td></td><td>${entry.receiverGroup} - ${entry.receiverMember}</td><td>₹${entry.amount.toFixed(2)}</td>`;
                    tbody.appendChild(contributionRow);
                    contributorTotal += entry.amount;
                });

                const totalRow = document.createElement("tr");
                totalRow.classList.add("matrix-total-row");
                totalRow.innerHTML = `<td colspan="2">Contributor Total</td><td>₹${contributorTotal.toFixed(2)}</td>`;
                tbody.appendChild(totalRow);
            }
        }


        // Get Matix Data        
        function getMatrixData() {
            const matrix = [];

            // Read data from Receiver's table
            const receiverTable = document.getElementById("matrixTableReceiver").querySelector("tbody").rows;
            let currentGroup = null;

            Array.from(receiverTable).forEach(row => {
                const cells = row.cells;

                // Check if the row has cells to avoid undefined errors
                if (!cells || cells.length === 0) return;

                // Group Header Row (with colspan)
                if (row.classList.contains("matrix-group-header")) {
                    currentGroup = { group_name: cells[0].textContent.replace("Receiver Group: ", ""), members: [] };
                    matrix.push(currentGroup);
                }

                // Receiver Member Row
                else if (cells.length >= 3 && cells[1].textContent === "Total") {
                    currentGroup.members.push({
                        receiver: cells[0].textContent,
                        subtotal: parseFloat(cells[2].textContent.replace("₹", "").replace(",", "").trim()),
                        details: []
                    });
                }

                // Contributor Details Row
                else if (cells.length >= 3 && cells[1].textContent) {
                    const lastMember = currentGroup.members[currentGroup.members.length - 1];
                    if (lastMember) {
                        lastMember.details.push({
                            contributor: cells[1].textContent,
                            amount: parseFloat(cells[2].textContent.replace("₹", "").replace(",", "").trim())
                        });
                    }
                }
            });

            return { matrix };
        }


        // Clear field Post Add Contrinbutor CTA
        function clearContributorFields() {
            document.getElementById("contributorGroupName").value = "";
            document.getElementById("contributorPercentage").value = "";
            document.getElementById("contributorMembers").value = "";
        }

        // Clear field Post Add Receiever CTA 
        function clearReceiverFields() {
            document.getElementById("receiverGroupName").value = "";
            document.getElementById("receiverPercentage").value = "";
            document.getElementById("receiverMembers").value = "";
        }

        // Display Contributor group in preview table   
        function displayContributorGroups() {
            const tbody = document.getElementById("contributorPreviewTable").querySelector("tbody");
            tbody.innerHTML = "";

            contributors.forEach(group => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${group.name}</td>
                    <td>${group.percentage}</td>
                    <td>${group.members.join(", ")}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Display Receiver group in preview table     
        function displayReceiverGroups() {
            const tbody = document.getElementById("receiverPreviewTable").querySelector("tbody");
            tbody.innerHTML = "";

            receivers.forEach(group => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${group.name}</td>
                    <td>${group.percentage}</td>
                    <td>${group.members.join(", ")}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // PNG Export
        document.getElementById("exportPNG").addEventListener("click", function () {
            // Export Receiver's Perspective Table as PNG
            const receiverTable = document.getElementById("matrixTableReceiver");
            html2canvas(receiverTable, { scale: 2 }).then(canvas => {
                const link = document.createElement("a");
                link.href = canvas.toDataURL("image/png");
                link.download = "receiver_perspective.png";
                link.click();
            });

            // Export Contributor's Perspective Table as PNG
            const contributorTable = document.getElementById("matrixTableContributor");
            html2canvas(contributorTable, { scale: 2 }).then(canvas => {
                const link = document.createElement("a");
                link.href = canvas.toDataURL("image/png");
                link.download = "contributor_perspective.png";
                link.click();
            });
        });

        // Export PDF Button Event Listener
        document.getElementById("exportPDF").addEventListener("click", function () {
            fetch("/export_pdf", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(getMatrixData())
            })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "amount_distribution.pdf";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                });
        });

        // Export CSV Button Event Listener
        document.getElementById("exportCSV").addEventListener("click", function () {
            fetch("/export_csv", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(getMatrixData())
            })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "amount_distribution.csv";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                });
        });

        // Export Excel Button Event Listener
        document.getElementById("exportExcel").addEventListener("click", function () {
            // Gather data from Receiver's table
            const receiverData = [["Receiver Group", "Receiver Member", "Contributor", "Amount (₹)"]];
            const receiverRows = document.getElementById("matrixTableReceiver").querySelector("tbody").rows;

            Array.from(receiverRows).forEach(row => {
                const cells = row.cells;
                if (cells.length === 3) {
                    receiverData.push([cells[0].textContent, cells[1].textContent, cells[2].textContent]);
                }
            });

            // Gather data from Contributor's table
            const contributorData = [["Contributor", "Receiver Group / Member", "Amount (₹)"]];
            const contributorRows = document.getElementById("matrixTableContributor").querySelector("tbody").rows;

            Array.from(contributorRows).forEach(row => {
                const cells = row.cells;
                if (cells.length === 3) {
                    contributorData.push([cells[0].textContent, cells[1].textContent, cells[2].textContent]);
                }
            });

            // Create Excel workbook and sheets
            const wb = XLSX.utils.book_new();

            // Add Receiver's Perspective sheet
            const wsReceiver = XLSX.utils.aoa_to_sheet(receiverData);
            XLSX.utils.book_append_sheet(wb, wsReceiver, "Receiver's Perspective");

            // Add Contributor's Perspective sheet
            const wsContributor = XLSX.utils.aoa_to_sheet(contributorData);
            XLSX.utils.book_append_sheet(wb, wsContributor, "Contributor's Perspective");

            // Export the workbook
            XLSX.writeFile(wb, "amount_distribution.xlsx");
        });



        // Reset Button Event Listener
        document.addEventListener("DOMContentLoaded", function () {
            // Attach the reset button event listener
            const resetButton = document.getElementById("resetPage");

            if (resetButton) {
                resetButton.addEventListener("click", function () {
                    console.log("Reset button clicked!");

                    // Scroll to the top of the page
                    window.scrollTo(0, 0);

                    // Reload the page to reset all fields, tables, and data
                    location.reload();
                });
            } else {
                console.error("Reset button not found!");
            }
        });
    </script>
</body>

</html>